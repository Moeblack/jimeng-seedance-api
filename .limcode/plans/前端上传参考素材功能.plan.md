
# å‰ç«¯ä¸Šä¼ å‚è€ƒç´ æåŠŸèƒ½

## åç«¯èƒ½åŠ›ç¡®è®¤

**åç«¯å·²å®Œæ•´æ”¯æŒ**ï¼Œæ— éœ€æ”¹åŠ¨åç«¯ä»£ç ã€‚å¼‚æ­¥ç«¯ç‚¹ `POST /v1/async/videos/generations` æ¥å— `multipart/form-data`ï¼š

| åŠŸèƒ½æ¨¡å¼ | `functionMode` | æ”¯æŒç´ æ | æ•°é‡é™åˆ¶ | å­—æ®µå |
|---|---|---|---|---|
| æ™®é€šæ¨¡å¼ | `first_last_frames`ï¼ˆé»˜è®¤ï¼‰ | å›¾ç‰‡ | â‰¤2 å¼  | ä»»æ„å­—æ®µåï¼Œå–å‰2ä¸ª |
| å…¨èƒ½æ¨¡å¼ | `omni_reference` | å›¾ç‰‡+è§†é¢‘ | å›¾ç‰‡â‰¤9, è§†é¢‘â‰¤3, æ€»â‰¤12 | `image_file_1`~`image_file_9`, `video_file_1`~`video_file_3` |

**ä»… seedance-2.0 / seedance-2.0-fast æ”¯æŒ `omni_reference`ã€‚**

## å‰ç«¯æ”¹åŠ¨ï¼ˆä»… index.htmlï¼‰

### 1. Video Tab UI æ–°å¢

åœ¨ Prompt ä¹‹å‰æ’å…¥ä¸€ä¸ª Win2000 é£æ ¼çš„ `<fieldset>` ç´ æä¸Šä¼ åŒºï¼š

```html
<fieldset>
  <legend>ğŸ“ Reference Files (Optional)</legend>

  <!-- æ¨¡å¼é€‰æ‹© -->
  <div class="field-row">
    <label>Mode:</label>
    <select v-model="videoForm.functionMode">
      <option value="first_last_frames">Standard (Imageâ†’Video)</option>
      <option value="omni_reference">Omni Reference âœ¨</option>
    </select>
  </div>

  <!-- æ™®é€šæ¨¡å¼ï¼šæœ€å¤š2å¼ å›¾ç‰‡ -->
  <div v-if="videoForm.functionMode === 'first_last_frames'">
    <div class="field-row">
      <label>Images (â‰¤2):</label>
      <input type="file" accept="image/*" multiple
             @change="onStandardFiles($event)" style="flex:1;">
    </div>
    <div class="file-list" v-if="videoForm.standardFiles.length">
      <div v-for="(f, i) in videoForm.standardFiles" :key="i" class="file-tag">
        ğŸ–¼ï¸ {{ f.name }} <button @click="removeStandardFile(i)">Ã—</button>
      </div>
    </div>
  </div>

  <!-- å…¨èƒ½æ¨¡å¼ï¼šå›¾ç‰‡+è§†é¢‘ï¼Œå¸¦åºå·æ ‡ç­¾ -->
  <div v-if="videoForm.functionMode === 'omni_reference'">
    <div class="field-row">
      <label>Images (â‰¤9):</label>
      <input type="file" accept="image/*" multiple
             @change="onOmniImages($event)" style="flex:1;">
    </div>
    <div class="file-list" v-if="videoForm.omniImages.length">
      <div v-for="(f, i) in videoForm.omniImages" :key="i" class="file-tag">
        ğŸ–¼ï¸ @image_file_{{ i+1 }}: {{ f.name }} <button @click="removeOmniImage(i)">Ã—</button>
      </div>
    </div>
    <div class="field-row" style="margin-top: 5px;">
      <label>Videos (â‰¤3):</label>
      <input type="file" accept="video/*" multiple
             @change="onOmniVideos($event)" style="flex:1;">
    </div>
    <div class="file-list" v-if="videoForm.omniVideos.length">
      <div v-for="(f, i) in videoForm.omniVideos" :key="i" class="file-tag">
        ğŸ¬ @video_file_{{ i+1 }}: {{ f.name }} <button @click="removeOmniVideo(i)">Ã—</button>
      </div>
    </div>
    <p style="font-size:10px; color:#808080; margin-top:5px;">
      ğŸ’¡ Tip: Use @image_file_1, @video_file_1, etc. in your prompt to reference materials.
    </p>
  </div>
</fieldset>
```

### 2. CSS æ–°å¢

```css
.file-list {
  display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px;
}
.file-tag {
  display: inline-flex; align-items: center; gap: 3px;
  background: #fff; border: 1px solid #808080;
  padding: 2px 6px; font-size: 11px;
}
.file-tag button {
  background: none; border: none; cursor: pointer;
  color: #800000; font-weight: bold; padding: 0 2px;
  font-size: 12px; min-width: auto;
}
```

### 3. JavaScript é€»è¾‘

#### 3.1 videoForm æ‰©å±•

```javascript
const videoForm = reactive({
  model: 'jimeng-video-seedance-2.0-fast',
  ratio: '16:9',
  duration: 5,
  prompt: '',
  functionMode: 'first_last_frames',
  standardFiles: [],   // File[]ï¼Œæ™®é€šæ¨¡å¼æœ€å¤š2å¼ å›¾
  omniImages: [],       // File[]ï¼Œå…¨èƒ½æ¨¡å¼æœ€å¤š9å¼ å›¾
  omniVideos: [],       // File[]ï¼Œå…¨èƒ½æ¨¡å¼æœ€å¤š3ä¸ªè§†é¢‘
});
```

#### 3.2 æ–‡ä»¶é€‰æ‹©å¤„ç†

```javascript
const onStandardFiles = (e) => {
  const files = Array.from(e.target.files);
  videoForm.standardFiles = files.slice(0, 2);
  e.target.value = '';
};
const removeStandardFile = (i) => videoForm.standardFiles.splice(i, 1);

const onOmniImages = (e) => {
  const files = Array.from(e.target.files);
  const total = videoForm.omniImages.length + files.length;
  videoForm.omniImages.push(...files.slice(0, Math.max(0, 9 - videoForm.omniImages.length)));
  e.target.value = '';
};
const removeOmniImage = (i) => videoForm.omniImages.splice(i, 1);

const onOmniVideos = (e) => {
  const files = Array.from(e.target.files);
  videoForm.omniVideos.push(...files.slice(0, Math.max(0, 3 - videoForm.omniVideos.length)));
  e.target.value = '';
};
const removeOmniVideo = (i) => videoForm.omniVideos.splice(i, 1);
```

#### 3.3 submitVideoTask æ”¹é€ 

åŸæ¥ç”¨ JSON bodyï¼Œç°åœ¨æ”¹ä¸ºæ ¹æ®æ˜¯å¦æœ‰æ–‡ä»¶å†³å®šç”¨ `FormData`ï¼š

```javascript
const submitVideoTask = async () => {
  // ...
  const hasFiles = videoForm.standardFiles.length > 0
    || videoForm.omniImages.length > 0
    || videoForm.omniVideos.length > 0;

  if (hasFiles) {
    const fd = new FormData();
    fd.append('prompt', videoForm.prompt);
    fd.append('model', videoForm.model);
    fd.append('ratio', videoForm.ratio);
    fd.append('duration', String(videoForm.duration));
    fd.append('functionMode', videoForm.functionMode);

    if (videoForm.functionMode === 'first_last_frames') {
      videoForm.standardFiles.forEach(f => fd.append('image', f));
    } else {
      videoForm.omniImages.forEach((f, i) => fd.append(`image_file_${i+1}`, f));
      videoForm.omniVideos.forEach((f, i) => fd.append(`video_file_${i+1}`, f));
    }

    const res = await axios.post(
      `${config.apiUrl}/v1/async/videos/generations`,
      fd,
      { headers: { 'Authorization': `Bearer ${config.sessionToken}` } }
    );
    // ... å¤„ç† res
  } else {
    // åŸæœ‰ JSON è·¯å¾„ä¸å˜
    const payload = { ...videoForm, duration: parseInt(videoForm.duration) };
    const res = await api.post('/v1/async/videos/generations', payload);
    // ...
  }
};
```

#### 3.4 æ¨¡å¼è‡ªåŠ¨è”åŠ¨

å½“é€‰æ‹©é seedance æ¨¡å‹æ—¶ï¼Œè‡ªåŠ¨å›é€€åˆ°æ™®é€šæ¨¡å¼ï¼š
```javascript
watch(() => videoForm.model, (val) => {
  if (!val.includes('seedance') && videoForm.functionMode === 'omni_reference') {
    videoForm.functionMode = 'first_last_frames';
  }
});
```

å½“åˆ‡æ¢æ¨¡å¼æ—¶æ¸…ç©ºå¦ä¸€æ¨¡å¼çš„æ–‡ä»¶ï¼š
```javascript
watch(() => videoForm.functionMode, () => {
  videoForm.standardFiles = [];
  videoForm.omniImages = [];
  videoForm.omniVideos = [];
});
```

### 4. æ¨¡å‹å…¼å®¹æç¤º

å…¨èƒ½æ¨¡å¼ä¸‹æ‹‰åªæœ‰ seedance-2.0 å’Œ seedance-2.0-fast å¯é€‰æ—¶æ‰å‡ºç°ï¼ˆæˆ–å§‹ç»ˆå±•ç¤ºï¼Œé€‰é seedance æ—¶ omni_reference é€‰é¡¹ç½®ç°/ç¦ç”¨ï¼‰ã€‚

## éƒ¨ç½²

```bash
scp index.html moeblack@10.0.0.63:~/jimeng-api/index.html
# åŒæ­¥åˆ°ç‹¬ç«‹ä»“åº“
cp index.html ../jimeng-async-ui/ && cd ../jimeng-async-ui && git add . && git commit -m "feat: add reference file upload for video generation" && git push
```

## TODO LIST

<!-- LIMCODE_TODO_LIST_START -->
- [ ] éƒ¨ç½²åˆ°è¿œç¨‹æœåŠ¡å™¨ + åŒæ­¥ jimeng-async-ui ä»“åº“  `#deploy-sync`
- [ ] æ¨¡å‹è”åŠ¨: é seedance æ¨¡å‹è‡ªåŠ¨å›é€€åˆ°æ™®é€šæ¨¡å¼ï¼Œåˆ‡æ¢æ¨¡å¼æ—¶æ¸…ç©ºæ–‡ä»¶  `#model-interlock`
- [ ] submitVideoTask æ”¹é€ : æœ‰æ–‡ä»¶æ—¶ä½¿ç”¨ FormData æäº¤ï¼Œæ— æ–‡ä»¶æ—¶ä¿æŒ JSON  `#submit-formdata`
- [ ] videoForm æ‰©å±•: æ–°å¢ functionMode/standardFiles/omniImages/omniVideos å­—æ®µåŠæ–‡ä»¶é€‰æ‹©å¤„ç†æ–¹æ³•  `#upload-state`
- [ ] Video Tab UI: æ–°å¢ Reference Files fieldsetï¼ˆæ™®é€šæ¨¡å¼ + å…¨èƒ½æ¨¡å¼ï¼‰ï¼Œæ·»åŠ æ–‡ä»¶åˆ—è¡¨ CSS  `#upload-ui`
<!-- LIMCODE_TODO_LIST_END -->
